#!/bin/bash

set -e

echo "Custom s2i script"

shopt -s dotglob

echo "=> Installing application source..."
pushd /code
rm -rf ./* && mv /tmp/src/* ./

if [ -f composer.json ]; then
    echo "=> Found 'composer.json'"

    if [ -d /tmp/artifacts ] && [ "$(ls -a /tmp/artifacts/ 2>/dev/null)" ]; then
        echo "=> Restoring build artifacts"
        mv /tmp/artifacts/* $HOME/
    fi

    # Install App dependencies using Composer
    echo "=> Running Composer install"
    echo "   composer install --no-dev --prefer-dist --no-interaction --no-ansi --optimize-autoloader"
    composer install --no-dev --prefer-dist --no-interaction --no-ansi --optimize-autoloader
fi

# Remove all .git directories to save space.
echo "=> Remove Git artifacts"
find . -name .git -type d -exec rm -rf {} +
popd

# Fix source directory permissions
echo "=> Fix permissions"
# fix-permissions ./
